# 7.3

## 肖臻教授第10节 BTC分叉

### **产生分叉的情况**

#### [1]对区块链状态产生了分歧：state fork

如果两个节点差不多同时挖到一个区块，这两个区块都是挂在当前的区块上的，不同节点先收到的区块不同，就会各自沿着先收到的区块往下扩展，这种时候就会出现临时性的分叉，称为**state fork，即由于对区块链当前的状态有意见分歧而产生的分叉**。

分叉攻击（forking attack）也属于state fork，只不过这种意见分歧是**人为造成的**，这种情况也称为**deliberate fork**。

#### [2]比特币的协议发生了改变：protocol fork

要修改比特币协议需要软件升级，**在去中心化的系统中，没办法要求所有的结点都升级软件**（因为它们根本不需要哪个中心化的节点提供服务）。

假设大部分节点升级了软件，少部分节点没有升级（可能是没来得及升级，也可能是不同意协议的修改），**这种分叉称为protocol fork，即对比特币协议产生了分歧，使用不同版本的协议而产生的分叉。**

在protocol fork中，根据**对协议修改的内容的不同**，又可以分为硬分叉和软分叉。

##### 硬分叉（hard fork）

如果对比特币协议增加一些新的特性，扩展一些新的功能，这时候没有升级协议的那些结点是不认可这些特性的（认为它们是非法的）。

这样的分叉是**永久性的**，只要这些旧节点不更新软件，这样的分叉就不会消失。比特币网络中，会有部分很保守的人，像这样的协议更新势必会有一些节点不同意，产生硬分叉。

出现硬分叉之后，就相当于社区分裂了，**出现了两条平行运行的链**，**两条链上的BTC也是不相干的，各挖各的矿**。在某条链上的出块奖励，对于认可这条链为最长合法链的节点而言是有效的，对认可另一条链的则是无效的，而分裂之前产生的BTC则是在两条链上都认可的。从这个意义上来看，**硬分叉可以认为是产生了新的一种加密货币**。


##### 软分叉（soft fork）

如果**对比特币协议加了一些限制，使得原本某些合法的交易或区块，在限制后的新协议中变得不合法**，那么形成的分叉是软分叉。

相比硬分叉，**软分叉即是非永久存在的分叉，只会临时存在一段时间**。

### **实际当中可能出现软分叉的情况**

#### [1]给某些目前协议中没有规定的域增加新的含义

这种情况下即是当前协议中未限制的一些域，被赋予了新的规则。一个例子就是铸币交易的CoinBase域，没人规定也没人检查。前面学习挖矿难度时，提到这个域可以作为extra nonce来使用，比如拿出前8个字节来和nonce一起调整，以增大挖矿的搜索空间。

#### [2]增加新的功能

前面学的P2SH（Pay to Script Hash）形式的交易脚本，最开始的比特币系统中是没有的，是后来通过软分叉的方式加进去的。

### **总结protocol fork**

#### 软分叉的特点

只要系统中半数以上（算力）的节点更新了软件，就不会出现永久性的分叉。这类分叉为软分叉。

#### 硬分叉的特点

必须系统中所有（算力）的节点都更新了软件，才不会出现永久性的分叉